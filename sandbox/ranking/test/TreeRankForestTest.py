
import numpy
import unittest
import logging 
import sys 
from sandbox.ranking.TreeRankForest import TreeRankForest
from sandbox.ranking.RankNode import RankNode
from sandbox.ranking.leafrank.SVMLeafRank import SVMLeafRank
from sandbox.ranking.leafrank.DecisionTree import DecisionTree
from sandbox.util.PathDefaults import PathDefaults
from sandbox.util.Evaluator import Evaluator
from sandbox.data.Standardiser import Standardiser
from sandbox.data.ExamplesGenerator import ExamplesGenerator

class TreeRankForestTest(unittest.TestCase):
    def setUp(self):
        numpy.random.seed(21)
        numpy.seterr(all="raise")

        self.folds = 5 
        self.paramDict = {} 
        self.paramDict["setC"] = 2**numpy.arange(-10, 10, dtype=numpy.float)  
        #self.paramDict["setC"] = numpy.array([10], dtype=numpy.float)  
        self.leafRanklearner = SVMLeafRank(self.paramDict, self.folds)

        numExamples = 500
        numFeatures = 10

        self.X = numpy.random.rand(numExamples, numFeatures)
        self.y = numpy.array(numpy.sign(numpy.random.rand(numExamples)-0.5), numpy.int)
        
        logging.basicConfig(stream=sys.stdout, level=logging.DEBUG)

    def testInit(self):
        treeRank = TreeRankForest(self.leafRanklearner)

    #@unittest.skip("")
    def testLearnModel(self):
        maxDepth = 2
        treeRankForest = TreeRankForest(self.leafRanklearner)
        treeRankForest.setMaxDepth(maxDepth)
        treeRankForest.learnModel(self.X, self.y)

        forest = treeRankForest.getForest()

        self.assertEquals(len(forest), treeRankForest.getNumTrees())

        for treeRank in forest:
            tree = treeRank.getTree()
            self.assertTrue(tree.depth() <= maxDepth)

    #@unittest.skip("")
    def testPredict(self):
        maxDepth = 2
        treeRankForest = TreeRankForest(self.leafRanklearner)
        treeRankForest.setMaxDepth(maxDepth)
        treeRankForest.learnModel(self.X, self.y)

        scores = treeRankForest.predict(self.X)
        scores2 = numpy.zeros(self.X.shape[0])
        forest = treeRankForest.getForest()

        for i in range(len(forest)):
            scores2 += forest[i].predict(self.X)

        scores2 /= treeRankForest.getNumTrees()

        self.assertTrue((scores==scores2).all())

    @unittest.skip("")
    def testPredict2(self):
        #Test on Gauss2D dataset
        dataDir = PathDefaults.getDataDir()

        fileName = dataDir + "Gauss2D_learn.csv"
        XY = numpy.loadtxt(fileName, skiprows=1, usecols=(1,2,3), delimiter=",")
        X = XY[:, 0:2]
        y = XY[:, 2]
        
        y = y*2 - 1 

        fileName = dataDir + "Gauss2D_test.csv"
        testXY = numpy.loadtxt(fileName, skiprows=1, usecols=(1,2,3), delimiter=",")
        testX = testXY[:, 0:2]
        testY = testXY[:, 2]
        
        testY = testY*2-1

        X = Standardiser().standardiseArray(X)
        testX = Standardiser().standardiseArray(testX)

        numTrees = 5
        minSplit = 50 
        maxDepths = range(3, 10)
        trainAucs = numpy.array([0.7252582, 0.7323278, 0.7350289, 0.7372529, 0.7399985, 0.7382176, 0.7395104, 0.7386347])
        testAucs = numpy.array([0.6806122, 0.6851614, 0.6886183, 0.6904147, 0.6897266, 0.6874600, 0.6875980, 0.6878801])

        i = 0
        
        #The results are approximately the same, but not exactly 
        for maxDepth in maxDepths:
            treeRankForest = TreeRankForest(self.leafRanklearner)
            treeRankForest.setMaxDepth(maxDepth)
            treeRankForest.setMinSplit(minSplit)
            treeRankForest.setNumTrees(numTrees)
            treeRankForest.learnModel(X, y)
            trainScores = treeRankForest.predict(X)
            testScores = treeRankForest.predict(testX)

            print(Evaluator.auc(trainScores, y), Evaluator.auc(testScores, testY))

            self.assertAlmostEquals(Evaluator.auc(trainScores, y), trainAucs[i], 1)
            self.assertAlmostEquals(Evaluator.auc(testScores, testY), testAucs[i], 1)
            i+=1

    @unittest.skip("")
    def testEvaluateCvOuter(self):
        maxDepth = 10
        treeRankForest = TreeRankForest(self.leafRanklearner)
        treeRankForest.setMaxDepth(maxDepth)

        folds = 3
        (bestParams, allMetrics, bestMetaDicts) = treeRankForest.evaluateCvOuter(self.X, self.y, folds)

        #print(allMetrics)

    def testVariableImportance(self):
        X, y, c = ExamplesGenerator().generateBinaryExamples(numExamples=100, verbose=True) 
        
        treeRankForest = TreeRankForest(self.leafRanklearner)
        treeRankForest.setFeatureSize(0.5)
        treeRankForest.setNumTrees(20)
        treeRankForest.setSampleSize(1.0)
        treeRankForest.learnModel(X, y)
        
        weightVector = treeRankForest.variableImportance(X, y)

        #Seems to work, sort of         
        print(c)
        print(weightVector)
        
        print(numpy.argsort(c))
        print(numpy.argsort(weightVector))

    def testStr(self):
        treeRankForest = TreeRankForest(self.leafRanklearner)

if __name__ == '__main__':
    unittest.main()

